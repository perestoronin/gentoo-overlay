From 129d661d114886803ddee9fc5f559e29ccf9a7ce Mon Sep 17 00:00:00 2001
From: Roel Aaij <roel.aaij@gmail.com>
Date: Sun, 26 Feb 2023 21:25:43 +0100
Subject: [PATCH] system zlib-ng and minizip-ng

---
 CMakeLists.txt                      | 8 +++-----
 Source/Core/Core/CMakeLists.txt     | 2 +-
 Source/Core/DiscIO/CMakeLists.txt   | 4 ++--
 Source/Core/UICommon/CMakeLists.txt | 2 +-
 4 files changed, 7 insertions(+), 9 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 2530c1a0ef..4cedcffff4 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -778,12 +778,10 @@ else()
   add_subdirectory(Externals/zstd)
 endif()
 
-add_subdirectory(Externals/zlib-ng)
-
-pkg_check_modules(MINIZIP minizip>=3.0.0)
-if(MINIZIP_FOUND)
+pkg_check_modules(zlib REQUIRED IMPORTED_TARGET zlib-ng>=2.0.0)
+pkg_check_modules(minizip REQUIRED IMPORTED_TARGET minizip-ng>=3.0.0)
+if(minizip_FOUND)
   message(STATUS "Using shared minizip")
-  include_directories(${MINIZIP_INCLUDE_DIRS})
 else()
   check_vendoring_approved(minizip)
   message(STATUS "Shared minizip not found, falling back to the static library")
diff --git a/Source/Core/Core/CMakeLists.txt b/Source/Core/Core/CMakeLists.txt
index 682c686c7d..017768d00d 100644
--- a/Source/Core/Core/CMakeLists.txt
+++ b/Source/Core/Core/CMakeLists.txt
@@ -612,7 +612,7 @@ PRIVATE
   FatFs
   fmt::fmt
   ${LZO}
-  ZLIB::ZLIB
+  PkgConfig::zlib
 )
 
 if ((DEFINED CMAKE_ANDROID_ARCH_ABI AND CMAKE_ANDROID_ARCH_ABI MATCHES "x86|x86_64") OR
diff --git a/Source/Core/DiscIO/CMakeLists.txt b/Source/Core/DiscIO/CMakeLists.txt
index b688d7a4d5..2a37372094 100644
--- a/Source/Core/DiscIO/CMakeLists.txt
+++ b/Source/Core/DiscIO/CMakeLists.txt
@@ -73,9 +73,9 @@ PUBLIC
 
 PRIVATE
   fmt::fmt
-  minizip-ng
+  PkgConfig::minizip
   pugixml
-  ZLIB::ZLIB
+  PkgConfig::zlib
 )
 
 if(MSVC)
diff --git a/Source/Core/UICommon/CMakeLists.txt b/Source/Core/UICommon/CMakeLists.txt
index f2ffbd0821..1585bd4587 100644
--- a/Source/Core/UICommon/CMakeLists.txt
+++ b/Source/Core/UICommon/CMakeLists.txt
@@ -33,7 +33,7 @@ PUBLIC
   cpp-optparse
   minizip-ng
   pugixml
-
+  PkgConfig::minizip
 PRIVATE
   fmt::fmt
   $<$<BOOL:APPLE>:${IOK_LIBRARY}>
-- 
2.39.2

